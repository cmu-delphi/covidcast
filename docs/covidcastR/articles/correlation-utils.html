<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Correlation utilities â€¢ covidcast</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Correlation utilities">
<meta property="og:description" content="covidcast">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">covidcast</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/covidcast.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/correlation-utils.html">Correlation utilities</a>
    </li>
    <li>
      <a href="../articles/plotting-signals.html">Plotting and mapping signals</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cmu-delphi/covidcast/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Correlation utilities</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/covidcast/blob/master/vignettes/correlation-utils.Rmd"><code>vignettes/correlation-utils.Rmd</code></a></small>
      <div class="hidden name"><code>correlation-utils.Rmd</code></div>

    </div>

    
    
<p>The covidcast package provides some simple utilities for exploring the correlations between two signals, over space or time, which may be helpful for simple analyses and explorations of data.</p>
<p>For these examples, we'll load confirmed cases and deaths to compare against, and restrict our analysis to counties with at least 500 total cases by August 15th.</p>
<div class="sourceCode"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/covidcast/covidcastR/">covidcast</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>

<span class="va">start_day</span> <span class="op">=</span> <span class="st">"2020-03-01"</span>
<span class="va">end_day</span> <span class="op">=</span> <span class="st">"2020-08-15"</span>

<span class="va">df_inum</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/covidcast_signal.html">covidcast_signal</a></span><span class="op">(</span>data_source <span class="op">=</span> <span class="st">"jhu-csse"</span>,
                   signal <span class="op">=</span> <span class="st">"confirmed_7dav_incidence_num"</span>, 
                   start_day <span class="op">=</span> <span class="va">start_day</span>, end_day <span class="op">=</span> <span class="va">end_day</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">df_inum</span><span class="op">)</span></pre></div>
<pre><code>## A `covidcast_signal` data frame with 536899 rows and 10 columns.
## 
## data_source : jhu-csse
## signal      : confirmed_7dav_incidence_num
## geo_type    : county
## 
## first date                          : 2020-03-01
## last date                           : 2020-08-15
## median number of geo_values per day : 3196</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="va">df_dnum</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/covidcast_signal.html">covidcast_signal</a></span><span class="op">(</span>data_source <span class="op">=</span> <span class="st">"jhu-csse"</span>,
                   signal <span class="op">=</span> <span class="st">"deaths_7dav_incidence_num"</span>, 
                   start_day <span class="op">=</span> <span class="va">start_day</span>, end_day <span class="op">=</span> <span class="va">end_day</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">df_dnum</span><span class="op">)</span></pre></div>
<pre><code>## A `covidcast_signal` data frame with 536899 rows and 10 columns.
## 
## data_source : jhu-csse
## signal      : deaths_7dav_incidence_num
## geo_type    : county
## 
## first date                          : 2020-03-01
## last date                           : 2020-08-15
## median number of geo_values per day : 3196</code></pre>
<div class="sourceCode"><pre class="downlit">
<span class="co"># Restrict attention to "active" counties with at least 500 total cases </span>
<span class="va">case_num</span> <span class="op">=</span> <span class="fl">500</span>
<span class="va">geo_values</span> <span class="op">=</span> <span class="va">df_inum</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">total</span> <span class="op">&gt;=</span> <span class="va">case_num</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span>
<span class="va">df_inum_act</span> <span class="op">=</span> <span class="va">df_inum</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op">%in%</span> <span class="va">geo_values</span><span class="op">)</span>
<span class="va">df_dnum_act</span> <span class="op">=</span> <span class="va">df_dnum</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op">%in%</span> <span class="va">geo_values</span><span class="op">)</span></pre></div>
<div id="correlations-sliced-by-time" class="section level2">
<h2 class="hasAnchor">
<a href="#correlations-sliced-by-time" class="anchor"></a>Correlations sliced by time</h2>
<p>The <code><a href="../reference/covidcast_cor.html">covidcast_cor()</a></code> function is your primary way to calculate correlations. The first option we have is to "slice by time": this calculates, for each time, correlation between the signals over all geographic locations. This is obtained by setting <code>by = "time_value"</code>:</p>
<div class="sourceCode"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>

<span class="co"># Compute correlation per time, over all counties</span>
<span class="va">df_cor1</span> <span class="op">=</span> <span class="fu"><a href="../reference/covidcast_cor.html">covidcast_cor</a></span><span class="op">(</span><span class="va">df_inum_act</span>, <span class="va">df_dnum_act</span>, by <span class="op">=</span> <span class="st">"time_value"</span><span class="op">)</span>

<span class="co"># Plot the correlation time series</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df_cor1</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Correlation between cases and deaths"</span>,
       subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Per day, over counties with at least %i cases"</span>, 
                          <span class="va">case_num</span><span class="op">)</span>,
       x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Correlation"</span><span class="op">)</span> </pre></div>
<p><img src="correlation-utils_files/figure-html/unnamed-chunk-3-1.png" width="768"></p>
<p>(The sudden drop on July 25th is due to a <a href="https://github.com/CSSEGISandData/COVID-19/issues/2763">sudden change in how New Jersey reported deaths</a> being reflected in our data source as large outliers; since the signal is a 7-day average, these outliers last until the beginning of July and affect the reported correlation.)</p>
<p>We might also be interested in how cases now correlate with deaths in the <em>future</em>. Using the <code>dt_x</code> parameter, we can shift the signal by 10 days forward in time, before calculating correlations:</p>
<div class="sourceCode"><pre class="downlit">
<span class="co"># Same, but now shift incident cases numbers by 10 days forward in time</span>
<span class="va">df_cor2</span> <span class="op">=</span> <span class="fu"><a href="../reference/covidcast_cor.html">covidcast_cor</a></span><span class="op">(</span><span class="va">df_inum_act</span>, <span class="va">df_dnum_act</span>, by <span class="op">=</span> <span class="st">"time_value"</span>, dt_x <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>

<span class="co"># Stack rowwise into one data frame, then plot time series</span>
<span class="va">df_cor</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">df_cor1</span>, <span class="va">df_cor2</span><span class="op">)</span>
<span class="va">df_cor</span><span class="op">$</span><span class="va">Shift</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_cor1</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_cor2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df_cor</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">Shift</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Correlation between cases and deaths"</span>,
       subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Per day, over counties with at least %i cases"</span>, 
                          <span class="va">case_num</span><span class="op">)</span>,
       x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Correlation"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></pre></div>
<p><img src="correlation-utils_files/figure-html/unnamed-chunk-4-1.png" width="768"></p>
<p>We can see that, for the most part, shifting the cases time series forward by 10 days improves correlations, showing that cases are better correlated with deaths 10 days from now.</p>
<p>We can also look at Spearman (rank) correlation, which is a more robust measure of correlation: it's invariant to monotone transformations, and doesn't rely on any particular functional form for the dependence between two variables.</p>
<div class="sourceCode"><pre class="downlit">
<span class="co"># Repeat this comparison, but now using Spearman (rank) correlation</span>
<span class="va">df_cor1</span> <span class="op">=</span> <span class="fu"><a href="../reference/covidcast_cor.html">covidcast_cor</a></span><span class="op">(</span><span class="va">df_inum_act</span>, <span class="va">df_dnum_act</span>, by <span class="op">=</span> <span class="st">"time_value"</span>, 
                        method <span class="op">=</span> <span class="st">"spearman"</span><span class="op">)</span>
<span class="va">df_cor2</span> <span class="op">=</span> <span class="fu"><a href="../reference/covidcast_cor.html">covidcast_cor</a></span><span class="op">(</span><span class="va">df_inum_act</span>, <span class="va">df_dnum_act</span>, by <span class="op">=</span> <span class="st">"time_value"</span>, dt_x <span class="op">=</span> <span class="fl">10</span>,
                        method <span class="op">=</span> <span class="st">"spearman"</span><span class="op">)</span>

<span class="co"># Stack rowwise into one data frame, then plot time series</span>
<span class="va">df_cor</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">df_cor1</span>, <span class="va">df_cor2</span><span class="op">)</span>
<span class="va">df_cor</span><span class="op">$</span><span class="va">Shift</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_cor1</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_cor2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df_cor</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">Shift</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Correlation between cases and deaths"</span>,
       subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"Per day, over counties with at least %i cases"</span>, <span class="va">case_num</span><span class="op">)</span>,
       x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Correlation"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></pre></div>
<p><img src="correlation-utils_files/figure-html/unnamed-chunk-5-1.png" width="768"></p>
<p>The "big dip" is gone (since the Spearman correlation uses ranks and not the actual values, and hence is less sensitive to outliers), and we can again see that the shift helps correlations.</p>
</div>
<div id="correlations-sliced-by-county" class="section level2">
<h2 class="hasAnchor">
<a href="#correlations-sliced-by-county" class="anchor"></a>Correlations sliced by county</h2>
<p>The second option we have is to "slice by location": this calculates, for each geographic location, correlation between the time series of two signals. This is obtained by setting <code>by = "geo_value"</code>. We'll again look at correlations both for observations at the same time and for a 10-day shift:</p>
<div class="sourceCode"><pre class="downlit">
<span class="co"># Compute correlation per county, over all times</span>
<span class="va">df_cor1</span> <span class="op">=</span> <span class="fu"><a href="../reference/covidcast_cor.html">covidcast_cor</a></span><span class="op">(</span><span class="va">df_inum_act</span>, <span class="va">df_dnum_act</span>, by <span class="op">=</span> <span class="st">"geo_value"</span><span class="op">)</span>
<span class="va">df_cor2</span> <span class="op">=</span> <span class="fu"><a href="../reference/covidcast_cor.html">covidcast_cor</a></span><span class="op">(</span><span class="va">df_inum_act</span>, <span class="va">df_dnum_act</span>, by <span class="op">=</span> <span class="st">"geo_value"</span>, dt_x <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>

<span class="co"># Stack rowwise into one data frame, then plot densities</span>
<span class="va">df_cor</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">df_cor1</span>, <span class="va">df_cor2</span><span class="op">)</span>
<span class="va">df_cor</span><span class="op">$</span><span class="va">Shift</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_cor1</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_cor2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df_cor</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">Shift</span>, fill <span class="op">=</span> <span class="va">Shift</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Correlation between cases and deaths"</span>,
       subtitle <span class="op">=</span> <span class="st">"Computed separately for each county, over all times"</span>,
       x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></pre></div>
<p><img src="correlation-utils_files/figure-html/unnamed-chunk-6-1.png" width="768"></p>
<p>Using some tricks, we can attach the necessary properties to the data frame so we can plot these correlations in space as a choropleth map, using <code><a href="../reference/plot.covidcast_signal.html">plot.covidcast_signal()</a></code>:</p>
<div class="sourceCode"><pre class="downlit">
<span class="co"># Set a bunch of fields so that the data frame knows how to plot itself</span>
<span class="va">df_cor2</span><span class="op">$</span><span class="va">time_value</span> <span class="op">=</span> <span class="va">start_day</span>
<span class="va">df_cor2</span><span class="op">$</span><span class="va">issue</span> <span class="op">=</span> <span class="va">start_day</span>
<span class="fu"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span><span class="op">(</span><span class="va">df_cor2</span><span class="op">)</span><span class="op">$</span><span class="va">geo_type</span> <span class="op">=</span> <span class="st">"county"</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">df_cor2</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"covidcast_signal"</span>, <span class="st">"data.frame"</span><span class="op">)</span>

<span class="co"># Plot choropleth maps, using the covidcast plotting functionality</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">df_cor2</span>, title <span class="op">=</span> <span class="st">"Correlations between 10-day shifted cases and deaths"</span>,
     range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, choro_col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"orange"</span>,<span class="st">"lightblue"</span>, <span class="st">"purple"</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="correlation-utils_files/figure-html/unnamed-chunk-7-1.png" width="960"></p>
</div>
<div id="more-systematic-lag-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#more-systematic-lag-analysis" class="anchor"></a>More systematic lag analysis</h2>
<p>You could also imagine trying to move the signals with various lags to see at what lag one signal is most correlated with the other. A simple way to achieve this:</p>
<div class="sourceCode"><pre class="downlit">
<span class="co"># Loop over values for the time shift, and compute correlations per county</span>
<span class="va">dt_vec</span> <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">15</span>
<span class="va">df_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">dt_vec</span><span class="op">)</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">dt_vec</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">df_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="../reference/covidcast_cor.html">covidcast_cor</a></span><span class="op">(</span><span class="va">df_inum_act</span>, <span class="va">df_dnum_act</span>, dt_x <span class="op">=</span> <span class="va">dt_vec</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
                               by <span class="op">=</span> <span class="st">"geo_value"</span><span class="op">)</span>
  <span class="va">df_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">dt</span> <span class="op">=</span> <span class="va">dt_vec</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
<span class="op">}</span>

<span class="co"># Stack into one big data frame, and then plot the median correlation by shift</span>
<span class="va">df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">df_list</span><span class="op">)</span>
<span class="va">df</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">value</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop_last"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dt</span>, y <span class="op">=</span> <span class="va">median</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Median correlation between cases and deaths"</span>,
       x <span class="op">=</span> <span class="st">"Shift"</span>, y <span class="op">=</span> <span class="st">"Correlation"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>, legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="correlation-utils_files/figure-html/unnamed-chunk-8-1.png" width="576"></p>
<p>We can see that the median correlation between cases and deaths (where the correlations come from slicing by location) is maximized when we shift the case incidence numbers 8 days forward in time.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jacob Bien, Logan Brooks, David Farrow, Pedrito Maynard-Zhang, Alex Reinhart, Ryan Tibshirani.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
