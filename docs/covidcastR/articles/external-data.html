<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>4. Combine external data sources and COVIDcast data • covidcast</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="4. Combine external data sources and COVIDcast data">
<meta property="og:description" content="Load external datasets, map them, and analyze them with the same tools provided for COVIDcast data.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">covidcast</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/covidcast.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/plotting-signals.html">1. Plotting and mapping signals</a>
    </li>
    <li>
      <a href="../articles/correlation-utils.html">2. Computing signal correlations</a>
    </li>
    <li>
      <a href="../articles/multi-signals.html">3. Manipulating multiple signals</a>
    </li>
    <li>
      <a href="../articles/external-data.html">4. Combine external data sources and COVIDcast data</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cmu-delphi/covidcast/tree/main/R-packages/covidcast">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><link href="external-data_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="external-data_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>4. Combine external data sources and COVIDcast data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/covidcast/blob/main/R-packages/covidcast/vignettes/external-data.Rmd"><code>vignettes/external-data.Rmd</code></a></small>
      <div class="hidden name"><code>external-data.Rmd</code></div>

    </div>

    
    
<p>While the COVIDcast Epidata API provides numerous useful COVID data streams, you may sometimes find yourself with relevant data from a different source. This package provides the tools you need to load such data and use it alongside COVIDcast data—for example, you can calculate correlations with <code><a href="../reference/covidcast_cor.html">covidcast_cor()</a></code> and make maps using <code><a href="../reference/plot.covidcast_signal.html">plot.covidcast_signal()</a></code>.</p>
<p>Let’s illustrate this in action using data from the <a href="https://covidtracking.com/">COVID Tracking Project</a>. They provide <a href="https://covidtracking.com/data/download">CSV files for download</a> containing daily state-level data on numerous metrics, including cases, deaths, hospitalizations, and test results.</p>
<div id="loading-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#loading-the-data" class="anchor"></a>Loading the data</h2>
<p>We’ve saved a sample of the data in this package to use as an example. Let’s load it and examine a few columns using <code><a href="https://rdrr.io/pkg/knitr/man/kable.html">knitr::kable()</a></code> to print them nicely:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>

<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"covid-tracking-project-oct-2020.csv"</span>,
                             package <span class="op">=</span> <span class="st">"covidcast"</span>, mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>

<span class="va">data</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">state</span>, <span class="va">death</span>, <span class="va">deathIncrease</span>, <span class="va">hospitalizedCurrently</span>,
           <span class="va">hospitalizedIncrease</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="op">)</span></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">date</th>
<th align="left">state</th>
<th align="right">death</th>
<th align="right">deathIncrease</th>
<th align="right">hospitalizedCurrently</th>
<th align="right">hospitalizedIncrease</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">2020-10-31</td>
<td align="left">AK</td>
<td align="right">82</td>
<td align="right">1</td>
<td align="right">94</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="left">2020-10-31</td>
<td align="left">AL</td>
<td align="right">2967</td>
<td align="right">35</td>
<td align="right">960</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">2020-10-31</td>
<td align="left">AR</td>
<td align="right">1925</td>
<td align="right">25</td>
<td align="right">652</td>
<td align="right">35</td>
</tr>
<tr class="even">
<td align="left">2020-10-31</td>
<td align="left">AS</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">NA</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">2020-10-31</td>
<td align="left">AZ</td>
<td align="right">5979</td>
<td align="right">45</td>
<td align="right">889</td>
<td align="right">68</td>
</tr>
<tr class="even">
<td align="left">2020-10-31</td>
<td align="left">CA</td>
<td align="right">17626</td>
<td align="right">55</td>
<td align="right">3212</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p>This is in a convenient format: Each day’s observations for each state are in one row. Suppose we would like to extract <code>hospitalizedIncrease</code> as a signal we want to map and analyze alongside other data fetched with <code><a href="../reference/covidcast_signal.html">covidcast_signal()</a></code>.</p>
<p>To do this, we use <code><a href="../reference/as.covidcast_signal.html">as.covidcast_signal()</a></code>. It expects a data frame with at least three columns:</p>
<ul>
<li>
<code>time_value</code>: a <code>Date</code> object giving the observation date</li>
<li>
<code>value</code>: the value of the observation, such as the number of deaths or hospitalizations</li>
<li>
<code>geo_value</code>: the location, such as state or county, in the same form as returned by <code><a href="../reference/covidcast_signal.html">covidcast_signal()</a></code> (such as two-letter lowercase abbreviations for states and FIPS codes for counties)</li>
</ul>
<p>Other columns are preserved unchanged. (In particular, if an <code>issue</code> column is present, it is used as the issue date of each observation. This is important if your data source includes multiple revisions of each observation.) <code><a href="../reference/as.covidcast_signal.html">as.covidcast_signal()</a></code> also needs to know the <code>geo_type</code> (state, in this case) and source/signal name to apply to the data. With a bit of <a href="https://dplyr.tidyverse.org/">dplyr</a> data wrangling, we can do this easily:</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/covidcast/covidcastR/">covidcast</a></span><span class="op">)</span>

<span class="va">hospitalized</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>time_value <span class="op">=</span> <span class="va">date</span>,
           geo_value <span class="op">=</span> <span class="va">state</span>,
           value <span class="op">=</span> <span class="va">hospitalizedIncrease</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>geo_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html">tolower</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span>,
           time_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">time_value</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/as.covidcast_signal.html">as.covidcast_signal</a></span><span class="op">(</span>geo_type <span class="op">=</span> <span class="st">"state"</span>,
                        data_source <span class="op">=</span> <span class="st">"covid-tracking"</span>,
                        signal <span class="op">=</span> <span class="st">"hospitalized_increase"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">hospitalized</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="op">)</span></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">data_source</th>
<th align="left">signal</th>
<th align="left">geo_value</th>
<th align="left">time_value</th>
<th align="right">value</th>
<th align="left">issue</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">covid-tracking</td>
<td align="left">hospitalized_increase</td>
<td align="left">ak</td>
<td align="left">2020-10-31</td>
<td align="right">7</td>
<td align="left">2021-01-19</td>
</tr>
<tr class="even">
<td align="left">covid-tracking</td>
<td align="left">hospitalized_increase</td>
<td align="left">al</td>
<td align="left">2020-10-31</td>
<td align="right">0</td>
<td align="left">2021-01-19</td>
</tr>
<tr class="odd">
<td align="left">covid-tracking</td>
<td align="left">hospitalized_increase</td>
<td align="left">ar</td>
<td align="left">2020-10-31</td>
<td align="right">35</td>
<td align="left">2021-01-19</td>
</tr>
<tr class="even">
<td align="left">covid-tracking</td>
<td align="left">hospitalized_increase</td>
<td align="left">as</td>
<td align="left">2020-10-31</td>
<td align="right">0</td>
<td align="left">2021-01-19</td>
</tr>
<tr class="odd">
<td align="left">covid-tracking</td>
<td align="left">hospitalized_increase</td>
<td align="left">az</td>
<td align="left">2020-10-31</td>
<td align="right">68</td>
<td align="left">2021-01-19</td>
</tr>
<tr class="even">
<td align="left">covid-tracking</td>
<td align="left">hospitalized_increase</td>
<td align="left">ca</td>
<td align="left">2020-10-31</td>
<td align="right">0</td>
<td align="left">2021-01-19</td>
</tr>
</tbody>
</table>
<p>This allows us to make maps using the same functions used for other COVIDcast data:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">hospitalized</span>, plot_type <span class="op">=</span> <span class="st">"choro"</span><span class="op">)</span></pre></div>
<pre><code>## Warning: Metadata for signal mean and standard deviation not available;
## defaulting to observed mean and standard deviation to set plot range.</code></pre>
<p><img src="external-data_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
</div>
<div id="analysis-alongside-other-signals" class="section level2">
<h2 class="hasAnchor">
<a href="#analysis-alongside-other-signals" class="anchor"></a>Analysis alongside other signals</h2>
<p>Now that our data is loaded as a <code>covidcast_signal</code> object, we can use it alongside other signals from the API. For example, let’s examine how new COVID hospitalizations correlate with outpatient doctor visits with deaths during October 2020, where we use death data as reported by the API.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="va">deaths</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/covidcast_signal.html">covidcast_signal</a></span><span class="op">(</span><span class="st">"indicator-combination"</span>, <span class="st">"deaths_incidence_prop"</span>,
                           start_day <span class="op">=</span> <span class="st">"2020-10-01"</span>,
                           end_day <span class="op">=</span> <span class="st">"2020-10-31"</span>,
                           geo_type <span class="op">=</span> <span class="st">"state"</span><span class="op">)</span>

<span class="fu"><a href="../reference/covidcast_cor.html">covidcast_cor</a></span><span class="op">(</span><span class="va">deaths</span>, <span class="va">hospitalized</span>, by <span class="op">=</span> <span class="st">"time_value"</span><span class="op">)</span></pre></div>
<pre><code>## # A tibble: 31 x 2
##    time_value   value
##    &lt;date&gt;       &lt;dbl&gt;
##  1 2020-10-01  0.146 
##  2 2020-10-02  0.240 
##  3 2020-10-03  0.0772
##  4 2020-10-04  0.183 
##  5 2020-10-05 -0.126 
##  6 2020-10-06  0.160 
##  7 2020-10-07  0.0513
##  8 2020-10-08  0.0611
##  9 2020-10-09  0.0447
## 10 2020-10-10  0.138 
## # … with 21 more rows</code></pre>
<p>We can also use the tools provided by this package to place both signals into a single data frame for analysis. For example, to build a model that uses hospitalizations and other data to predict deaths, it may be convenient to produce a data frame where each row represents one state on one day, and each column is a variable (such as hospitalization or death). Using <code><a href="../reference/aggregate_signals.html">aggregate_signals()</a></code>, this is easy:</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="va">death_hosp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aggregate_signals.html">aggregate_signals</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">deaths</span>, <span class="va">hospitalized</span><span class="op">)</span>,
                                format <span class="op">=</span> <span class="st">"wide"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">death_hosp</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="op">)</span></pre></div>
<table class="table">
<colgroup>
<col width="8%">
<col width="9%">
<col width="44%">
<col width="38%">
</colgroup>
<thead><tr class="header">
<th align="left">geo_value</th>
<th align="left">time_value</th>
<th align="right">value+0:indicator-combination_deaths_incidence_prop</th>
<th align="right">value+0:covid-tracking_hospitalized_increase</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">ks</td>
<td align="left">2020-10-26</td>
<td align="right">-0.0343252</td>
<td align="right">62</td>
</tr>
<tr class="even">
<td align="left">wa</td>
<td align="left">2020-10-29</td>
<td align="right">0.1181894</td>
<td align="right">25</td>
</tr>
<tr class="odd">
<td align="left">mo</td>
<td align="left">2020-10-19</td>
<td align="right">-0.5376845</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">va</td>
<td align="left">2020-10-24</td>
<td align="right">0.4334827</td>
<td align="right">16</td>
</tr>
<tr class="odd">
<td align="left">tx</td>
<td align="left">2020-10-31</td>
<td align="right">0.3069401</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">ga</td>
<td align="left">2020-10-29</td>
<td align="right">0.4332501</td>
<td align="right">146</td>
</tr>
</tbody>
</table>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jacob Bien, Logan Brooks, Sarah Colquhoun, David Farrow, Alex Reinhart, Ryan Tibshirani.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
