<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2. Estimate derivatives of signals • modeltools</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="2. Estimate derivatives of signals">
<meta property="og:description" content="Estimate derivatives of signal values, using various methodologies.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">modeltools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/modeltools.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/pct-change.html">1. Compute percentage change over time</a>
    </li>
    <li>
      <a href="../articles/estimate-deriv.html">2. Estimate derivatives of signals</a>
    </li>
    <li>
      <a href="../articles/quantgen-forecast.html">3. Produce and evaluate quantile forecasts</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/cmu-delphi/covidcast/tree/main/R-packages/modeltools">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="estimate-deriv_files/header-attrs-2.5/header-attrs.js"></script><link href="estimate-deriv_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="estimate-deriv_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>2. Estimate derivatives of signals</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/covidcast/blob/main/R-packages/modeltools/vignettes/estimate-deriv.Rmd"><code>vignettes/estimate-deriv.Rmd</code></a></small>
      <div class="hidden name"><code>estimate-deriv.Rmd</code></div>

    </div>

    
    
<p>In this vignette, we’ll take a look at estimating derivatives of signals using the <code><a href="../reference/estimate_deriv.html">estimate_deriv()</a></code> function. We’ll again demonstrate this functionality on state-level COVID-19 case rates, smoothed via 7-day trailing averages, from the USAFacts data source.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">covidcast</span>)</pre></body></html></div>
<pre><code>## We encourage COVIDcast API users to register on our mailing list:
## https://lists.andrew.cmu.edu/mailman/listinfo/delphi-covidcast-api
## We'll send announcements about new data sources, package updates,
## server maintenance, and new features.</code></pre>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">start_day</span> <span class="kw">&lt;-</span> <span class="st">"2020-06-01"</span>
<span class="no">end_day</span> <span class="kw">&lt;-</span> <span class="st">"2020-11-15"</span>
<span class="no">geo_values</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"ca"</span>, <span class="st">"fl"</span>, <span class="st">"ny"</span>, <span class="st">"tx"</span>)

<span class="no">case_rates</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span>(
  <span class="fu"><a href="https://rdrr.io/pkg/covidcast/man/covidcast_signal.html">covidcast_signal</a></span>(<span class="kw">data_source</span> <span class="kw">=</span> <span class="st">"usa-facts"</span>,
                   <span class="kw">signal</span> <span class="kw">=</span> <span class="st">"confirmed_7dav_incidence_prop"</span>,
                   <span class="kw">start_day</span> <span class="kw">=</span> <span class="no">start_day</span>, <span class="kw">end_day</span> <span class="kw">=</span> <span class="no">end_day</span>,
                   <span class="kw">geo_type</span> <span class="kw">=</span> <span class="st">"state"</span>, <span class="kw">geo_values</span> <span class="kw">=</span> <span class="no">geo_values</span>))

<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">case_rates</span>)</pre></body></html></div>
<pre><code>## A `covidcast_signal` data frame with 672 rows and 9 columns.
## 
## data_source : usa-facts
## signal      : confirmed_7dav_incidence_prop
## geo_type    : state
## 
## first date                          : 2020-06-01
## last date                           : 2020-11-15
## median number of geo_values per day : 4</code></pre>
<div id="estimating-derivatives-via-linear-regression" class="section level2">
<h2 class="hasAnchor">
<a href="#estimating-derivatives-via-linear-regression" class="anchor"></a>Estimating derivatives via linear regression</h2>
<p>The function for estimating derivatives is called <code><a href="../reference/estimate_deriv.html">estimate_deriv()</a></code>, and (aside from a <code>covidcast_signal</code> data frame) takes two primary arguments: <code>method</code>, indicating the method to use for derivative estimation; and <code>n</code> indicating the trailing sample size (number of days) to use in training the given method. Here we use <code>method = "lin"</code>, the default, which uses the slope from a simple linear regression, and <code>n = 14</code>, also the default.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">modeltools</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)

<span class="no">case_rates</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/estimate_deriv.html">estimate_deriv</a></span>(<span class="no">case_rates</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"lin"</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="fl">14</span>)

<span class="no">case_rates</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(<span class="no">geo_value</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">geo_value</span>, <span class="no">time_value</span>, <span class="no">value</span>, <span class="no">deriv</span>)</pre></body></html></div>
<pre><code>## # A tibble: 672 x 4
## # Rowwise: 
##    geo_value time_value value   deriv
##    &lt;chr&gt;     &lt;date&gt;     &lt;dbl&gt;   &lt;dbl&gt;
##  1 ca        2020-06-01  6.70 NA     
##  2 ca        2020-06-02  6.39 -0.312 
##  3 ca        2020-06-03  6.50 -0.102 
##  4 ca        2020-06-04  6.86  0.0593
##  5 ca        2020-06-05  7.11  0.129 
##  6 ca        2020-06-06  6.81  0.0874
##  7 ca        2020-06-07  6.74  0.0561
##  8 ca        2020-06-08  6.75  0.0393
##  9 ca        2020-06-09  6.99  0.0449
## 10 ca        2020-06-10  7.19  0.0561
## # … with 662 more rows</code></pre>
<p>We can see that a column <code>deriv</code> has been added to the output data frame, which contains the derivative estimates. Below we visualize these estimates in tandem with the signal itself. The red dots mark time points at which the derivative estimate exceeds a threshold (arbitrarily chosen) of 0.25. These seem to roughly but reasonably mark times of upswing in the underlying signal.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">gridExtra</span>)

<span class="no">state</span> <span class="kw">=</span> <span class="st">"fl"</span>
<span class="no">threshold</span> <span class="kw">=</span> <span class="fl">0.25</span>

<span class="no">p1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">case_rates</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">geo_value</span> <span class="kw">==</span> <span class="no">state</span>),
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">value</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">case_rates</span> <span class="kw">%&gt;%</span>
               <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">geo_value</span> <span class="kw">==</span> <span class="no">state</span>, <span class="no">deriv</span> <span class="kw">&gt;=</span> <span class="no">threshold</span>),
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">value</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"red"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Cases per 100,00 people"</span>)

<span class="no">p2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">case_rates</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">geo_value</span> <span class="kw">==</span> <span class="no">state</span>),
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">deriv</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="no">threshold</span>, <span class="kw">linetype</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Derivative (linear regression)"</span>)

<span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span>(<span class="no">p1</span>, <span class="no">p2</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="fl">1</span>)</pre></body></html></div>
<p><img src="estimate-deriv_files/figure-html/unnamed-chunk-3-1.png" width="768"></p>
</div>
<div id="estimating-derivatives-via-smoothing-spline" class="section level2">
<h2 class="hasAnchor">
<a href="#estimating-derivatives-via-smoothing-spline" class="anchor"></a>Estimating derivatives via smoothing spline</h2>
<p>Now we consider <code>method = "ss"</code>, which uses a smoothing spline for the estimate of the derivative. That is, at each time point, we fit a natural cubic spline to the data from the trailing <code>n</code> days, and return the derivative of the underlying fitted spline at the current time as the estimate. Here we set <code>n = 28</code>, a bit higher sample size, and fit the spline in two ways: first, using a fixed degrees of freedom of 8; and second, using cross-validation to choose the amount of regularization (tuning parameter). This is accomplished by passing additional arguments to <code><a href="../reference/estimate_deriv.html">estimate_deriv()</a></code>, which are in turn passed on to the underlying function it uses to fit smoothing splines, <code><a href="https://rdrr.io/r/stats/smooth.spline.html">stats::smooth.spline()</a></code>. Note that we also set a custom name for the output column with the estimated derivatives, via the <code>col_name</code> argument.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">case_rates</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/estimate_deriv.html">estimate_deriv</a></span>(<span class="no">case_rates</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"ss"</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="fl">28</span>,
                             <span class="kw">col_name</span> <span class="kw">=</span> <span class="st">"deriv_ss1"</span>, <span class="kw">df</span> <span class="kw">=</span> <span class="fl">8</span>)

<span class="no">case_rates</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/estimate_deriv.html">estimate_deriv</a></span>(<span class="no">case_rates</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"ss"</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="fl">28</span>,
                             <span class="kw">col_name</span> <span class="kw">=</span> <span class="st">"deriv_ss2"</span>, <span class="kw">cv</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="no">p1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">case_rates</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">geo_value</span> <span class="kw">==</span> <span class="no">state</span>),
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">value</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">case_rates</span> <span class="kw">%&gt;%</span>
               <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">geo_value</span> <span class="kw">==</span> <span class="no">state</span>, <span class="no">deriv_ss1</span> <span class="kw">&gt;=</span> <span class="no">threshold</span>),
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">value</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"red"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">case_rates</span> <span class="kw">%&gt;%</span>
               <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">geo_value</span> <span class="kw">==</span> <span class="no">state</span>, <span class="no">deriv_ss2</span> <span class="kw">&gt;=</span> <span class="no">threshold</span>),
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">value</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"blue"</span>, <span class="kw">shape</span> <span class="kw">=</span> <span class="fl">21</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Cases per 100,00 people"</span>)

<span class="no">p2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">case_rates</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">geo_value</span> <span class="kw">==</span> <span class="no">state</span>),
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">deriv_ss1</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"red"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">deriv_ss2</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"blue"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="no">threshold</span>, <span class="kw">linetype</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Derivative (smoothing spline)"</span>)

<span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span>(<span class="no">p1</span>, <span class="no">p2</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="fl">1</span>)</pre></body></html></div>
<p><img src="estimate-deriv_files/figure-html/unnamed-chunk-4-1.png" width="768"></p>
<p>The estimated derivates—in red for the smoothing spline with a fixed degrees of freedom of 8, and in blue for that tuned by cross-validation—appear less smooth than those above, from linear regression. Using cross-validation offers more adaptivity to the time-varying level of smoothness, as is apparent from comparing the red and blue derivative estimates in October and November.</p>
</div>
<div id="estimating-derivatives-via-trend-filtering" class="section level2">
<h2 class="hasAnchor">
<a href="#estimating-derivatives-via-trend-filtering" class="anchor"></a>Estimating derivatives via trend filtering</h2>
<p>Lastly we consider <code>method = tf"</code>, which uses trend filtering for estimating the derivative. That is, at each time point, we fit a discrete spline of quadratic order to the data from the trailing <code>n</code> days, and return the discrete derivative of the underlying fitted spline at the current time as the estimate. As before, we fit the spline in two ways: first, using a fixed degrees of freedom of 8; and second, using cross-validation to choose the amount of regularization. Since the optimization here takes a while (it’s based on computing a full solution path<br>
for the trend filtering problem, via the <code><a href="https://rdrr.io/pkg/genlasso/man/trendfilter.html">genlasso::trendfilter()</a></code> function), we only compute derivatives for Florida.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">case_rates_state</span> <span class="kw">&lt;-</span> <span class="no">case_rates</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">geo_value</span> <span class="kw">==</span> <span class="no">state</span>)

<span class="no">case_rates_state</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/estimate_deriv.html">estimate_deriv</a></span>(<span class="no">case_rates_state</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"tf"</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="fl">28</span>,
                                   <span class="kw">col_name</span> <span class="kw">=</span> <span class="st">"deriv_tf1"</span>, <span class="kw">df</span> <span class="kw">=</span> <span class="fl">8</span>)

<span class="no">case_rates_state</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/estimate_deriv.html">estimate_deriv</a></span>(<span class="no">case_rates_state</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"tf"</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="fl">28</span>,
                                   <span class="kw">col_name</span> <span class="kw">=</span> <span class="st">"deriv_tf2"</span>, <span class="kw">cv</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="no">p1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">case_rates_state</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">value</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">case_rates_state</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">deriv_tf1</span> <span class="kw">&gt;=</span> <span class="no">threshold</span>),
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">value</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"red"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">case_rates_state</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">deriv_tf2</span> <span class="kw">&gt;=</span> <span class="no">threshold</span>),
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">value</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"blue"</span>, <span class="kw">shape</span> <span class="kw">=</span> <span class="fl">21</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Cases per 100,00 people"</span>)

<span class="no">p2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">case_rates_state</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">time_value</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">deriv_tf1</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"red"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">deriv_tf2</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"blue"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="no">threshold</span>, <span class="kw">linetype</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Date"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Derivative (trend filtering)"</span>)

<span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span>(<span class="no">p1</span>, <span class="no">p2</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="fl">1</span>)</pre></body></html></div>
<pre><code>## Warning: Removed 3 row(s) containing missing values (geom_path).</code></pre>
<pre><code>## Warning: Removed 6 row(s) containing missing values (geom_path).</code></pre>
<p><img src="estimate-deriv_files/figure-html/unnamed-chunk-5-1.png" width="768"></p>
<p>The estimated derivates now appear a bit smoother than the last ones, from the smoothing spline methods. Again, using cross-validation offers a noticeable improvement in adapting to to the time-varying level of smoothness, as is very clear from the differences between red and blue derivative estimates in October and November.</p>
</div>
<div id="post-hoc-inspection" class="section level2">
<h2 class="hasAnchor">
<a href="#post-hoc-inspection" class="anchor"></a>Post-hoc inspection</h2>
<p>In the call to <code><a href="../reference/estimate_deriv.html">estimate_deriv()</a></code>, we can set <code>keep_obj = TRUE</code> to keep around a second column with the fitted model objects. For example, here, we can look at the p-values associated with the estimated slopes from <code><a href="https://rdrr.io/r/stats/lsfit.html">lsfit()</a></code>.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">case_rates</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/estimate_deriv.html">estimate_deriv</a></span>(<span class="no">case_rates</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"lin"</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="fl">14</span>,
                             <span class="kw">keep_obj</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span>(<span class="no">case_rates</span>$<span class="no">deriv_obj</span>)</pre></body></html></div>
<pre><code>## [1] "list"</code></pre>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/stats/ls.print.html">ls.print</a></span>(<span class="no">case_rates</span>$<span class="no">deriv_obj</span><span class="kw">[[</span><span class="fl">7</span>]])</pre></body></html></div>
<pre><code>## Residual Standard Error=0.224
## R-Square=0.2598
## F-statistic (df=1, 5)=1.7552
## p-value=0.2425
## 
##             Estimate  Std.Err t-value Pr(&gt;|t|)
## Intercept -1026.3201 779.7444 -1.3162   0.2452
## X             0.0561   0.0423  1.3249   0.2425</code></pre>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">case_rates</span> <span class="kw">&lt;-</span> <span class="no">case_rates</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">p_value</span> <span class="kw">=</span> <span class="fu">quiet</span>(
    <span class="fu"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/ls.print.html">ls.print</a></span>(<span class="no">deriv_obj</span>)$<span class="no">coef.table</span><span class="kw">[[</span><span class="fl">1</span>]][<span class="fl">2</span>,<span class="st">"Pr(&gt;|t|)"</span>],
             <span class="kw">error</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">e</span>) <span class="fl">NA</span>)))

<span class="no">case_rates</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(<span class="no">geo_value</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">geo_value</span>, <span class="no">time_value</span>, <span class="no">value</span>, <span class="no">deriv</span>, <span class="no">deriv_obj</span>, <span class="no">p_value</span>)</pre></body></html></div>
<pre><code>## # A tibble: 672 x 6
## # Rowwise: 
##    geo_value time_value value   deriv deriv_obj         p_value
##    &lt;chr&gt;     &lt;date&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;list&gt;              &lt;dbl&gt;
##  1 ca        2020-06-01  6.70 NA      &lt;lgl [1]&gt;         NA     
##  2 ca        2020-06-02  6.39 -0.312  &lt;named list [4]&gt; NaN     
##  3 ca        2020-06-03  6.50 -0.102  &lt;named list [4]&gt;   0.555 
##  4 ca        2020-06-04  6.86  0.0593 &lt;named list [4]&gt;   0.638 
##  5 ca        2020-06-05  7.11  0.129  &lt;named list [4]&gt;   0.180 
##  6 ca        2020-06-06  6.81  0.0874 &lt;named list [4]&gt;   0.182 
##  7 ca        2020-06-07  6.74  0.0561 &lt;named list [4]&gt;   0.243 
##  8 ca        2020-06-08  6.75  0.0393 &lt;named list [4]&gt;   0.278 
##  9 ca        2020-06-09  6.99  0.0449 &lt;named list [4]&gt;   0.125 
## 10 ca        2020-06-10  7.19  0.0561 &lt;named list [4]&gt;   0.0314
## # … with 662 more rows</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Ryan Tibshirani.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
